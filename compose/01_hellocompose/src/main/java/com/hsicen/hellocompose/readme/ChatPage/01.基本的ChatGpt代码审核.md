ä½ è¿™æ®µä»£ç å…¶å®å·²ç»å¾ˆå®Œæ•´äº†ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒç»å…¸çš„ **Jetpack Compose èŠå¤©é¡µé¢ Demo**ï¼Œé‡Œé¢æœ‰å‡ ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„ç‚¹ï¼Œæˆ‘å¸®ä½ æ¢³ç†ä¸€ä¸‹å…³é”®å®ç°ï¼š

---

### 1. é¡µé¢ç»“æ„

* `ChatPage`ï¼šä¸»ç•Œé¢ï¼ŒåŒ…å«é¡¶éƒ¨æ ‡é¢˜æ ã€èŠå¤©åˆ—è¡¨å’Œåº•éƒ¨è¾“å…¥æ¡†ã€‚
* `MessageItem`ï¼šå•æ¡æ¶ˆæ¯ï¼ˆæ ¹æ®æ˜¯å¦è‡ªå·±å‘é€åˆ‡æ¢ UI å’Œæ°”æ³¡æœå‘ï¼‰ã€‚
* `ChatBottomBar`ï¼šè¾“å…¥æ ï¼ˆåŒ…å«è¯­éŸ³æŒ‰é’®ã€è¾“å…¥æ¡†ã€ç‚¸å¼¹æŒ‰é’®ã€åŠ å·æŒ‰é’®ï¼‰ã€‚

---

### 2. é¡µé¢åˆ‡æ¢åŠ¨ç”»

```kotlin
val offsetX by animateFloatAsState(if (viewModel.chatting) 0f else 1f)
```

* å½“ `viewModel.chatting` ä¸º `true` æ—¶ï¼ŒèŠå¤©é¡µæ»‘å…¥ï¼ˆ`offsetX = 0`ï¼‰ã€‚
* å½“ä¸º `false` æ—¶ï¼Œæ»‘å‡ºï¼ˆ`offsetX = 1`ï¼‰ã€‚
* ç”¨äº†è‡ªå®šä¹‰çš„ `Modifier.offsetPercent()`ï¼Œæ ¹æ® **ç™¾åˆ†æ¯”** æ§åˆ¶åç§»ï¼Œè€Œä¸æ˜¯å›ºå®š dpã€‚

---

### 3. èŠå¤©æŠ–åŠ¨æ•ˆæœ

* `shakingTime`ï¼šæ¯æ¬¡ç‚¹å‡»ç‚¸å¼¹æŒ‰é’® `++`ï¼Œè§¦å‘ `LaunchedEffect`ã€‚
* èƒŒæ™¯æŠ–åŠ¨ï¼š

  ```kotlin
  val shakingOffset = remember { Animatable(0f) }
  LaunchedEffect(key1 = shakingTime) {
      if (shakingTime != 0) {
          shakingOffset.animateTo(
              0f,
              animationSpec = spring(0.3f, 600f),
              initialVelocity = -2000f
          )
      }
  }
  ```

  â†’ æ•´ä¸ªèŠå¤©åˆ—è¡¨ `LazyColumn` ä¼šä¸€èµ·â€œéœ‡åŠ¨â€ã€‚
* å•æ¡æ¶ˆæ¯æ°”æ³¡çš„æŠ–åŠ¨ï¼š

  ```kotlin
  val shakingAngleBubble = remember { Animatable(0f) }
  LaunchedEffect(key1 = shakingTime) {
      if (shakingTime != 0) {
          delay(shakingLevel.toLong() * 30)
          shakingAngleBubble.animateTo(
              0f,
              animationSpec = spring(0.4f, 500f),
              initialVelocity = 1200f / (1 + shakingLevel * 0.4f)
          )
      }
  }
  ```

  â†’ ä¸åŒæ¡æ¶ˆæ¯å»¶æ—¶è§¦å‘ï¼Œè§’åº¦ä¹Ÿä¸ä¸€æ ·ï¼Œæœ‰ç±»ä¼¼â€œçˆ†ç‚¸æ³¢åŠ¨â€çš„æ•ˆæœã€‚

---

### 4. æ°”æ³¡ç»˜åˆ¶

ç”¨äº† `Modifier.drawBehind` æ‰‹ç»˜æ¶ˆæ¯æ°”æ³¡ï¼Œè€Œä¸æ˜¯ç”¨ `Box + Shape`ï¼š

```kotlin
.drawBehind {
    val bubble = Path().apply {
        val rect = RoundRect(
            10.dp.toPx(),
            0f,
            size.width - 10.dp.toPx(),
            size.height,
            4.dp.toPx(),
            4.dp.toPx()
        )
        addRoundRect(rect)
        moveTo(size.width - 10.dp.toPx(), 15.dp.toPx())
        lineTo(size.width - 5.dp.toPx(), 20.dp.toPx())
        lineTo(size.width - 10.dp.toPx(), 25.dp.toPx())
        close()
    }
    drawPath(bubble, bubbleColor)
}
```

* è‡ªå·±ç”» `RoundRect` + å°ä¸‰è§’ï¼Œæ¨¡æ‹Ÿå¾®ä¿¡æ°”æ³¡çš„å°–è§’æ•ˆæœã€‚
* åˆ†åˆ«ç»™è‡ªå·±å’Œå¯¹æ–¹çš„æ¶ˆæ¯ç»˜åˆ¶åœ¨å·¦å³ã€‚

---

### 5. åº•éƒ¨è¾“å…¥æ 

* `BasicTextField` æ§åˆ¶è¾“å…¥ã€‚
* ä¸€ä¸ªç‚¸å¼¹ `Text("\uD83D\uDCA3")` è§¦å‘éœ‡åŠ¨æ•ˆæœã€‚
* ä¸¤è¾¹åˆ†åˆ«æœ‰è¯­éŸ³å’ŒåŠ å·æŒ‰é’®ã€‚

---

### 6. äº®ç‚¹æ€»ç»“

* **é¡µé¢åˆ‡æ¢ç”¨ç™¾åˆ†æ¯”åç§»** â†’ çµæ´»ï¼Œé€‚é…ä¸åŒå±å¹•ã€‚
* **èƒŒæ™¯å’Œæ¶ˆæ¯åˆ†å±‚éœ‡åŠ¨** â†’ åŠ¨ç”»å¾ˆç»†è…»ã€‚
* **æ°”æ³¡ç”¨ Path æ‰‹ç»˜** â†’ æ›´æ¥è¿‘å¾®ä¿¡é£æ ¼ã€‚
* **ç‚¸å¼¹äº¤äº’æœ‰å±‚æ¬¡æ„Ÿ** â†’ å»¶è¿Ÿè§¦å‘ã€è§’åº¦é€’å‡ã€‚

---

ğŸ‘‰ è¿™å¥—å®ç°å·²ç»å¾ˆä¸é”™äº†ï¼Œä½†å¦‚æœä½ è¦è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š

* `Bubble` å¯ä»¥å•ç‹¬å°è£…æˆä¸€ä¸ª `Composable`ï¼Œä¸ç”¨åœ¨ `drawBehind` é‡Œå†™ Pathã€‚
* `shakingTime` å¯ä»¥ç”¨ `MutableSharedFlow` æ¥å¹¿æ’­ï¼Œè€Œä¸æ˜¯ç”¨ Int è®¡æ•°ã€‚
* èŠå¤©è®°å½•æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥ç»“åˆ `LazyListState.animateScrollToItem`ã€‚

è¦ä¸è¦æˆ‘å¸®ä½ æŠŠ **æ°”æ³¡ç»˜åˆ¶éƒ¨åˆ†** æŠ½å‡ºæ¥åšä¸€ä¸ªå¯å¤ç”¨çš„ `BubbleShape`ï¼Œè¿™æ ·å†™èµ·æ¥æ›´ç®€æ´ï¼Ÿ


-----------------------------------------------------------------------------------------------------------------------------------

å¥½çš„ ğŸ‘
ä½ çš„ `MessageItem` é‡Œé¢ **drawBehind æ‰‹ç»˜æ°”æ³¡** ä»£ç æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ°”æ³¡æŠ½å–å‡ºæ¥åšä¸€ä¸ª **BubbleShape**ï¼Œç„¶åç›´æ¥ç”¨ `Modifier.background(shape = BubbleShape(...))` æ¥æ›¿ä»£ã€‚è¿™æ ·ä»£ç æ¸…æ™°ã€å¤ç”¨æ€§æ›´å¥½ã€‚

ä¸‹é¢æˆ‘ç»™å‡ºä¿®æ”¹åçš„å®Œæ•´ä»£ç ï¼ˆä¿æŒåŠŸèƒ½ä¸€è‡´ï¼Œåªæ˜¯æŠŠæ°”æ³¡æŠ½å–å‡ºæ¥ï¼‰ï¼š

---

```kotlin
// -------------------- BubbleShape.kt --------------------
import androidx.compose.ui.geometry.CornerRadius
import androidx.compose.ui.geometry.RoundRect
import androidx.compose.ui.graphics.Outline
import androidx.compose.ui.graphics.Path
import androidx.compose.ui.graphics.Shape
import androidx.compose.ui.unit.Density
import androidx.compose.ui.unit.LayoutDirection
import androidx.compose.ui.unit.dp
import kotlin.math.roundToInt

/**
 * èŠå¤©æ°”æ³¡å½¢çŠ¶ï¼ˆæ”¯æŒå·¦/å³ä¸¤ç§å°–è§’ï¼‰
 */
class BubbleShape(
    private val isMe: Boolean
) : Shape {
    override fun createOutline(
        size: androidx.compose.ui.geometry.Size,
        layoutDirection: LayoutDirection,
        density: Density
    ): Outline {
        val corner = 4.dp.toPx(density)

        val path = Path().apply {
            // ä¸»ä½“åœ†è§’çŸ©å½¢
            addRoundRect(
                RoundRect(
                    left = 10.dp.toPx(density),
                    top = 0f,
                    right = size.width - 10.dp.toPx(density),
                    bottom = size.height,
                    cornerRadius = CornerRadius(corner, corner)
                )
            )

            // å°–è§’
            if (isMe) {
                // å³ä¾§æ°”æ³¡
                moveTo(size.width - 10.dp.toPx(density), 15.dp.toPx(density))
                lineTo(size.width - 5.dp.toPx(density), 20.dp.toPx(density))
                lineTo(size.width - 10.dp.toPx(density), 25.dp.toPx(density))
                close()
            } else {
                // å·¦ä¾§æ°”æ³¡
                moveTo(10.dp.toPx(density), 15.dp.toPx(density))
                lineTo(5.dp.toPx(density), 20.dp.toPx(density))
                lineTo(10.dp.toPx(density), 25.dp.toPx(density))
                close()
            }
        }
        return Outline.Generic(path)
    }

    private fun Float.dpToPx(density: Density): Float =
        with(density) { this@dpToPx.toDp().toPx() }
}
```

---

```kotlin
// -------------------- ChatPage.kt --------------------
@Composable
fun ChatPage(modifier: Modifier = Modifier) {
    val viewModel: WeViewModel = viewModel()
    val offsetX by animateFloatAsState(if (viewModel.chatting) 0f else 1f)

    val chat = viewModel.currentChat
    if (chat != null) {
        Column(
            modifier
                .offsetPercent(offsetX)
                .background(WeComposeTheme.colors.background)
                .fillMaxSize()
        ) {
            // é¡¶éƒ¨æ ‡é¢˜æ 
            WeTopBar(chat.friend.name) {
                viewModel.endChat()
            }

            // èƒŒæ™¯
            var shakingTime by remember { mutableStateOf(0) }
            Box(
                Modifier
                    .background(WeComposeTheme.colors.chatPage)
                    .weight(1f)
            ) {
                Box(
                    Modifier
                        .alpha(WeComposeTheme.colors.chatPageBgAlpha)
                        .fillMaxSize()
                ) {
                    Image(
                        painterResource(R.drawable.ic_bg_newyear_left), null,
                        Modifier
                            .align(Alignment.CenterStart)
                            .padding(bottom = 100.dp)
                    )
                    Image(
                        painterResource(R.drawable.ic_bg_newyear_top), null,
                        Modifier
                            .align(Alignment.TopEnd)
                            .padding(horizontal = 24.dp)
                    )
                    Image(
                        painterResource(R.drawable.ic_bg_newyear_right), null,
                        Modifier
                            .align(Alignment.BottomEnd)
                            .padding(vertical = 200.dp)
                    )
                }

                val shakingOffset = remember { Animatable(0f) }
                LaunchedEffect(key1 = shakingTime) {
                    if (shakingTime != 0) {
                        shakingOffset.animateTo(
                            0f,
                            animationSpec = spring(0.3f, 600f),
                            initialVelocity = -2000f
                        )
                    }
                }

                // èŠå¤©åˆ—è¡¨
                LazyColumn(
                    Modifier
                        .fillMaxSize()
                        .offset(shakingOffset.value.dp, shakingOffset.value.dp)
                ) {
                    items(chat.msgs.size) { index ->
                        val msg = chat.msgs[index]
                        MessageItem(msg, shakingTime, chat.msgs.size - index - 1)
                    }
                }
            }

            // åº•éƒ¨è¾“å…¥æ¡†
            ChatBottomBar(onBombClicked = {
                viewModel.boom(chat)
                shakingTime++
            })
        }
    }
}

@Composable
fun MessageItem(msg: Msg, shakingTime: Int, shakingLevel: Int) {
    val shakingAngleBubble = remember { Animatable(0f) }
    LaunchedEffect(key1 = shakingTime, block = {
        if (shakingTime != 0) {
            delay(shakingLevel.toLong() * 30)
            shakingAngleBubble.animateTo(
                0f,
                animationSpec = spring(0.4f, 500f),
                initialVelocity = 1200f / (1 + shakingLevel * 0.4f)
            )
        }
    })

    if (msg.from == User.Me) {
        Row(
            Modifier
                .fillMaxWidth()
                .padding(8.dp),
            horizontalArrangement = Arrangement.End
        ) {
            val bubbleColor = WeComposeTheme.colors.bubbleMe
            Text(
                msg.text,
                Modifier
                    .graphicsLayer(
                        rotationZ = shakingAngleBubble.value,
                        transformOrigin = TransformOrigin(1f, 0f)
                    )
                    .background(bubbleColor, BubbleShape(isMe = true))
                    .padding(20.dp, 10.dp),
                color = WeComposeTheme.colors.textPrimaryMe
            )

            Image(
                painterResource(msg.from.avatar),
                contentDescription = msg.from.name,
                Modifier
                    .graphicsLayer(
                        rotationZ = shakingAngleBubble.value * 0.6f,
                        transformOrigin = TransformOrigin(1f, 0f)
                    )
                    .size(40.dp)
                    .clip(RoundedCornerShape(4.dp))
            )
        }
    } else {
        Row(
            Modifier
                .fillMaxWidth()
                .padding(8.dp)
        ) {
            Image(
                painterResource(msg.from.avatar),
                contentDescription = msg.from.name,
                Modifier
                    .graphicsLayer(
                        rotationZ = -shakingAngleBubble.value * 0.6f,
                        transformOrigin = TransformOrigin(0f, 0f)
                    )
                    .size(40.dp)
                    .clip(RoundedCornerShape(4.dp))
            )

            val bubbleColor = WeComposeTheme.colors.bubbleOthers
            Text(
                msg.text,
                Modifier
                    .graphicsLayer(
                        rotationZ = -shakingAngleBubble.value,
                        transformOrigin = TransformOrigin(0f, 0f)
                    )
                    .background(bubbleColor, BubbleShape(isMe = false))
                    .padding(20.dp, 10.dp),
                color = WeComposeTheme.colors.textPrimary
            )
        }
    }
}
```

---

âœ… è¿™æ ·æ”¹å®Œä»¥åï¼š

* `BubbleShape` ç‹¬ç«‹æŠ½å–ï¼Œæ°”æ³¡å½¢çŠ¶å®šä¹‰é›†ä¸­åœ¨ä¸€èµ·ã€‚
* `MessageItem` ä¸­åªéœ€è¦å†™ `.background(color, BubbleShape(isMe))`ï¼Œé€»è¾‘æ›´ç›´è§‚ã€‚
* å¤ç”¨æ€§æå‡ï¼Œä»¥åè¦æ”¹æ°”æ³¡æ ·å¼ï¼ˆæ¯”å¦‚æ›´åœ†ã€æ›´å¤§çš„å°–è§’ï¼‰åªæ”¹ `BubbleShape` å³å¯ã€‚

è¦ä¸è¦æˆ‘å†å¸®ä½ åŠ ä¸€ä¸ª **åœ†è§’å’Œå°–è§’å¤§å°å¯é…ç½®** çš„ç‰ˆæœ¬ï¼Œè®©æ°”æ³¡ UI æ›´çµæ´»ï¼Ÿ
