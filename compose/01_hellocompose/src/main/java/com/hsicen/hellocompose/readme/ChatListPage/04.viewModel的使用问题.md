
## ğŸ”§ æ”¹è¿›å»ºè®®

### 1. é¿å…åœ¨ Item é‡Œç›´æ¥æ‹¿ `viewModel()`

```kotlin
val viewModel: WeViewModel = viewModel()
```

è¿™ç§å†™æ³•ä¼šè®© **æ¯ä¸ª item éƒ½å»æ‹¿ä¸€æ¬¡ ViewModel**ï¼Œè™½ç„¶è¿”å›çš„æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œä½†ä¼šè®©äººè¯¯è§£ã€‚
æ›´æ¨èåœ¨å¤–å±‚ä¼ è¿›æ¥ï¼Œä¿æŒ **å¯ç»„åˆå‡½æ•°çš„çº¯ç²¹æ€§**ï¼š

```kotlin
@Composable
private fun ChatListItem(chat: Chat, onClick: (Chat) -> Unit) {
  Row(
    Modifier
      .clickable { onClick(chat) }
      .fillMaxWidth()
  ) {
    ...
  }
}
```

è°ƒç”¨ï¼š

```kotlin
itemsIndexed(chats) { index, chat ->
  ChatListItem(chat) { viewModel.startChat(it) }
  ...
}
```

è¿™æ · `ChatListItem` åªè´Ÿè´£ UIï¼Œä¸å’Œä¸šåŠ¡è€¦åˆã€‚

---



-----------------------------------------------------------------------------------------------------------------------------------------

class MainActivity : ComponentActivity() {
    private val mViewModel by viewModels<WeViewModel>()

    override fun onCreate(savedInstanceState: Bundle?) {
        enableEdgeToEdge()
        super.onCreate(savedInstanceState)

        setContent {
            WeComposeTheme(mViewModel.theme) {
                Box {
                    Home(mViewModel)
                    ChatPage()
                }
            }
        }
    }

    override fun onBackPressed() {
        if (mViewModel.endChat().not()) {
            super.onBackPressed()
        }
    }
}

-----------------------------------------------------------------------------------------------------------------------------------------

viewModel() åªèƒ½ç»™composä½¿ç”¨ï¼Œ private val mViewModel by viewModels<WeViewModel>() è¿™ä¸ªå¯ä»¥åšåˆ°åŸç”Ÿå’Œcomposeä¸€èµ·ä½¿ç”¨å¯¹å—



å¯¹ï¼Œä½ ç†è§£å¾—å¾ˆå¯¹ ğŸ‘ã€‚æˆ‘å¸®ä½ æŠŠè¿™ä¸¤ç§æ–¹å¼æ¢³ç†æ¸…æ¥šï¼š

---

## 1. `viewModel()`ï¼ˆ`androidx.lifecycle.viewmodel.compose.viewModel`ï¼‰

* **åªèƒ½åœ¨ Composable å†…éƒ¨ä½¿ç”¨**ã€‚
* æ˜¯ **Compose æä¾›çš„æ‰©å±•å‡½æ•°**ï¼Œå¸®ä½ åœ¨ Composable ä¸­è·å– `ViewModel` å®ä¾‹ã€‚
* èƒŒåæ˜¯ä¾èµ– `LocalViewModelStoreOwner`ï¼ˆé€šå¸¸æ˜¯ Activity / NavBackStackEntryï¼‰ã€‚

ğŸ‘‰ ç‰¹ç‚¹ï¼š

* å†™èµ·æ¥å¾ˆç®€æ´ï¼š`val vm: WeViewModel = viewModel()`
* åªèƒ½åœ¨ **Composable ä¸–ç•Œé‡Œè°ƒç”¨**ï¼Œä¸èƒ½åœ¨ Fragmentã€Activity é‡Œç”¨ã€‚

---

## 2. `by viewModels<WeViewModel>()`ï¼ˆ`androidx.activity.viewModels` / `androidx.fragment.app.viewModels`ï¼‰

* **åŸç”Ÿ Activity / Fragment çš„æ ‡å‡†å†™æ³•**ã€‚
* åœ¨ Activity æˆ– Fragment ä¸­ä½¿ç”¨ï¼Œä¿è¯ç”Ÿå‘½å‘¨æœŸæ­£ç¡®ã€‚
* è¿™æ˜¯ **Jetpack ViewModel çš„åŸç”Ÿ API**ï¼Œå’Œ Compose æ²¡æœ‰è€¦åˆã€‚

ğŸ‘‰ ç‰¹ç‚¹ï¼š

* å¯ä»¥å’ŒåŸç”Ÿ UIã€Compose UI æ··ç”¨ã€‚
* æ¯”å¦‚ä¸€ä¸ª Fragment åŒæ—¶æœ‰ ComposeView å’Œä¼ ç»Ÿçš„ XML Viewï¼Œè¿™æ—¶ç”¨ `viewModels()` å–çš„å®ä¾‹èƒ½åœ¨ä¸¤è¾¹å…±äº«ã€‚

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“

| è·å–æ–¹å¼                        | ç”¨é€”åœºæ™¯                                | é€‚ç”¨èŒƒå›´             |
| --------------------------- | ----------------------------------- | ---------------- |
| `viewModel()` (Compose API) | åœ¨ Composable å†…éƒ¨è·å– ViewModel         | **ä»… Compose**    |
| `by viewModels()` (åŸç”Ÿ API)  | åœ¨ Activity / Fragment ä¸­è·å– ViewModel | **åŸç”Ÿ + Compose** |

---

## ğŸš€ æ¨èç”¨æ³•

å¦‚æœä½ å†™çš„æ˜¯ä¸€ä¸ªåŒæ—¶æ··åˆ **åŸç”Ÿ + Compose** çš„é¡µé¢ï¼Œé€šå¸¸è¿™æ ·ç”¨ï¼š

```kotlin
class ChatFragment : Fragment() {

    private val mViewModel by viewModels<WeViewModel>()

    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?
    ): View {
        return ComposeView(requireContext()).apply {
            setContent {
                // ä¼ å…¥åŸç”Ÿè·å–çš„ ViewModelï¼ŒCompose å’Œ XML å…±äº«ä¸€ä¸ªå®ä¾‹
                ChatListPage(viewModel = mViewModel)
            }
        }
    }
}
```

è¿™æ ·ï¼š

* Fragment åŸç”Ÿé€»è¾‘ï¼ˆæ¯”å¦‚ä¿å­˜æ•°æ®ã€å¤„ç†è¿”å›é”®ï¼‰èƒ½ç”¨åŒä¸€ä¸ª `mViewModel`ã€‚
* Compose UI ç›´æ¥å¤ç”¨è¿™ä¸ª `mViewModel`ï¼Œä¸ä¼šé‡å¤åˆ›å»ºã€‚

---

è¦ä¸è¦æˆ‘ç»™ä½ ç”»ä¸€ä¸ª **ç”Ÿå‘½å‘¨æœŸä¸ä½œç”¨åŸŸå¯¹æ¯”å›¾**ï¼ˆ`viewModel()` vs `by viewModels()`ï¼‰ï¼Œç›´è§‚å±•ç¤ºå®ƒä»¬åœ¨å“ªäº›æƒ…å†µä¸‹æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Ÿ


-----------------------------------------------------------------------------------------------------------------------------------------
Compose é‡Œé¢çš„viewmodel æ˜¯å› ä¸ºåœ¨åŒä¸€ä¸ªactivityæ‰€ä»¥æ‹¿åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹å—


å¯¹ï¼Œä½ è¯´çš„è¿™ä¸ªç†è§£ **åŸºæœ¬æ­£ç¡®** ğŸ‘ï¼Œæˆ‘å¸®ä½ æŠŠ Compose é‡Œçš„ `viewModel()` ä½œç”¨åŸŸæœºåˆ¶è¯´é€ä¸€ç‚¹ï¼š

---

## ğŸ“Œ Compose é‡Œçš„ `viewModel()` æ€ä¹ˆå·¥ä½œï¼Ÿ

`viewModel()` å†…éƒ¨æ˜¯é€šè¿‡ `ViewModelProvider` æ¥è·å– `ViewModel` å®ä¾‹çš„ï¼Œå®ƒéœ€è¦ä¸€ä¸ª **`ViewModelStoreOwner`**ã€‚

åœ¨ Compose ä¸–ç•Œé‡Œï¼Œè¿™ä¸ª `ViewModelStoreOwner` é€šå¸¸æ¥è‡ªï¼š

* **`LocalViewModelStoreOwner.current`**

  * é»˜è®¤å°±æ˜¯ **å®¿ä¸» Activity**ï¼ˆæ¯”å¦‚ `ComponentActivity`ï¼‰
  * æˆ–è€… **å®¿ä¸» Fragment**ï¼ˆå¦‚æœä½ åœ¨ Fragment çš„ `ComposeView` é‡Œè°ƒç”¨ï¼‰
  * æˆ–è€… **Navigation çš„ BackStackEntry**ï¼ˆå¦‚æœç”¨äº† `Navigation-Compose`ï¼‰

---

## ğŸ“Š ä¸¾ä¾‹è¯´æ˜

### åœºæ™¯ 1ï¼šä¸€ä¸ª Activityï¼Œé‡Œé¢æ”¾äº†å¤šä¸ª Composable

```kotlin
@Composable
fun ScreenA() {
    val vm: MyViewModel = viewModel()
}

@Composable
fun ScreenB() {
    val vm: MyViewModel = viewModel()
}
```

* `ScreenA` å’Œ `ScreenB` éƒ½åœ¨åŒä¸€ä¸ª Activity å†…éƒ¨ã€‚
* é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»¬æ‹¿åˆ°çš„æ˜¯ **åŒä¸€ä¸ª ViewModel å®ä¾‹**ã€‚

å› ä¸ºå®ƒä»¬ç”¨çš„ `ViewModelStoreOwner` æ˜¯ **Activity è‡ªå·±**ã€‚

---

### åœºæ™¯ 2ï¼šåŒä¸€ä¸ª Activityï¼Œä¸åŒ NavDestinationï¼ˆNavigation-Composeï¼‰

```kotlin
NavHost(navController, startDestination = "screenA") {
    composable("screenA") { val vm: MyViewModel = viewModel() }
    composable("screenB") { val vm: MyViewModel = viewModel() }
}
```

* å³ä½¿éƒ½åœ¨ä¸€ä¸ª Activity é‡Œï¼Œä½†å› ä¸ºæ¯ä¸ª **NavBackStackEntry** æ˜¯ç‹¬ç«‹çš„ `ViewModelStoreOwner`ã€‚
* æ‰€ä»¥ `screenA` å’Œ `screenB` çš„ `viewModel()` é»˜è®¤æ˜¯ **ä¸åŒçš„å®ä¾‹**ã€‚
* å¦‚æœä½ æƒ³å…±äº«ï¼Œå¯ä»¥ç”¨ï¼š

  ```kotlin
  val sharedVM: MyViewModel = viewModel(LocalContext.current as ComponentActivity)
  ```

---

### åœºæ™¯ 3ï¼šFragment + ComposeView

å¦‚æœä½ åœ¨ Fragment çš„ `onCreateView` é‡Œå†™ï¼š

```kotlin
ComposeView(requireContext()).apply {
    setContent {
        val vm: MyViewModel = viewModel()
    }
}
```

* è¿™é‡Œæ‹¿åˆ°çš„ `ViewModelStoreOwner` æ˜¯ **è¿™ä¸ª Fragment**ï¼Œè€Œä¸æ˜¯ Activityã€‚
* æ‰€ä»¥æ¯ä¸ª Fragment éƒ½ä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„ ViewModelã€‚

---

## âœ… æ€»ç»“

* **Compose é‡Œçš„ `viewModel()`**ï¼Œå–å†³äºå½“å‰ä¸Šä¸‹æ–‡æ˜¯è°ï¼š

  * Activity å†…éƒ¨ â†’ Activity ä½œç”¨åŸŸï¼Œæ‰€æœ‰ Composable å…±äº«ä¸€ä¸ªå®ä¾‹ã€‚
  * Fragment å†…éƒ¨ â†’ Fragment ä½œç”¨åŸŸã€‚
  * Nav-Compose â†’ æ¯ä¸ª Destination ä¸€ä¸ªå®ä¾‹ã€‚
* è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ åœ¨ **åŒä¸€ä¸ª Activity çš„å¤šä¸ª Composable é‡Œç”¨ `viewModel()`ï¼Œæ‹¿åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªå®ä¾‹**ã€‚

---

è¦ä¸è¦æˆ‘å¸®ä½ ç”»ä¸€ä¸ªã€Œä½œç”¨åŸŸæ ‘ã€çš„ç®€å›¾ï¼Ÿæ¯”å¦‚ **Activity â†’ Fragment â†’ NavBackStackEntry â†’ Composable**ï¼Œä¸€çœ¼çœ‹å‡º `viewModel()` åœ¨ä¸åŒå±‚çº§ä¸‹çš„å½’å±ã€‚


-----------------------------------------------------------------------------------------------------------------------------------------
 ä¸Šé¢å­˜åœ¨ç”Ÿå‘½å‘¨æœŸä¸ä¸€è‡´çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´å­˜åœ¨ä¾‹å¤–çš„æƒ…å½¢ï¼Œ

 æˆ‘ä»¬çš„æé—®ä¸»è¦é’ˆå¯¹ï¼š

 è¿™ç§å†™æ³•ä¼šè®© **æ¯ä¸ª item éƒ½å»æ‹¿ä¸€æ¬¡ ViewModel**ï¼Œè™½ç„¶è¿”å›çš„æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œä½†ä¼šè®©äººè¯¯è§£ã€‚
 æ›´æ¨èåœ¨å¤–å±‚ä¼ è¿›æ¥ï¼Œä¿æŒ **å¯ç»„åˆå‡½æ•°çš„çº¯ç²¹æ€§**ï¼š

-----------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------



