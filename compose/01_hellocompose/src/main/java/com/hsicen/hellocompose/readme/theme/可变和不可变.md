

@Stable
class WeComposeColors(
    isLight: Boolean,
    bottomBar: Color,
    background: Color,
    listItem: Color,
    divider: Color,
    chatPage: Color,
    textPrimary: Color,
    textPrimaryMe: Color,
    textSecondary: Color,
    onBackground: Color,
    icon: Color,
    iconCurrent: Color,
    badge: Color,
    onBadge: Color,
    bubbleMe: Color,
    bubbleOthers: Color,
    textFieldBackground: Color,
    more: Color,
    chatPageBgAlpha: Float,
) {
    var isLight: Boolean by mutableStateOf(isLight)
        private set

    var bottomBar: Color by mutableStateOf(bottomBar)
        private set
    var background: Color by mutableStateOf(background)
        private set
    var listItem: Color by mutableStateOf(listItem)
        private set
    var chatListDivider: Color by mutableStateOf(divider)
        private set
    var chatPage: Color by mutableStateOf(chatPage)
        private set
    var textPrimary: Color by mutableStateOf(textPrimary)
        private set
    var textPrimaryMe: Color by mutableStateOf(textPrimaryMe)
        private set
    var textSecondary: Color by mutableStateOf(textSecondary)
        private set
    var onBackground: Color by mutableStateOf(onBackground)
        private set
    var icon: Color by mutableStateOf(icon)
        private set
    var iconCurrent: Color by mutableStateOf(iconCurrent)
        private set
    var badge: Color by mutableStateOf(badge)
        private set
    var onBadge: Color by mutableStateOf(onBadge)
        private set
    var bubbleMe: Color by mutableStateOf(bubbleMe)
        private set
    var bubbleOthers: Color by mutableStateOf(bubbleOthers)
        private set
    var textFieldBackground: Color by mutableStateOf(textFieldBackground)
        private set
    var more: Color by mutableStateOf(more)
        private set
    var chatPageBgAlpha: Float by mutableStateOf(chatPageBgAlpha)
        private set
}


è¿™äº›å‚æ•°æ˜¯å¯å˜çš„è¿˜æ˜¯ä¸å¯å˜çš„

è¿™ä¸ªé—®é¢˜é—®å¾—éå¸¸åˆ°ä½ ğŸ‘

æˆ‘ä»¬å¯ä»¥ä» **æ„é€ å‚æ•°** å’Œ **ç±»å†…éƒ¨çŠ¶æ€** ä¸¤ä¸ªè§’åº¦æ¥åˆ†æï¼š

---

### ğŸ§© ä¸€ã€æ„é€ å‚æ•°å±‚é¢ï¼š**ä¸å¯å˜**

åœ¨è¿™ä¸€æ®µï¼š

```kotlin
@Stable
class WeComposeColors(
  bottomBar: Color,
  background: Color,
  listItem: Color,
  ...
)
```

è¿™äº›æ„é€ å‚æ•° (`bottomBar`, `background`, `listItem` ç­‰)
åªæ˜¯æ„é€ å‡½æ•°çš„ **å…¥å‚**ï¼Œæœ¬èº«æ˜¯ **ä¸å¯å˜çš„å±€éƒ¨å˜é‡**ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

* å®ƒä»¬åœ¨æ„é€ å‡½æ•°æ‰§è¡ŒæœŸé—´å¯ä»¥è¢«è¯»å–ï¼›
* ä½†ä¸€æ—¦æ„é€ å‡½æ•°æ‰§è¡Œå®Œï¼Œè¿™äº›å‚æ•°å°±è¶…å‡ºä½œç”¨åŸŸï¼›
* å®ƒä»¬ä¸æ˜¯ç±»çš„å±æ€§ï¼Œåªæ˜¯ç”¨æ¥åˆå§‹åŒ–ç±»å†…éƒ¨çœŸæ­£çš„çŠ¶æ€çš„ã€‚

---

### ğŸ§­ äºŒã€ç±»å†…éƒ¨çŠ¶æ€å±‚é¢ï¼š**å¯å˜**

åœ¨ç±»çš„å†…éƒ¨ï¼Œä½ å®šä¹‰äº†ï¼š

```kotlin
var bottomBar: Color by mutableStateOf(bottomBar)
  private set
```

è¿™æ‰æ˜¯ç±»çœŸæ­£æŒæœ‰çš„ **å¯è§‚å¯ŸçŠ¶æ€ï¼ˆstateï¼‰**ã€‚

è¿™é‡Œï¼š

* `var bottomBar` æ˜¯ **å¯å˜å±æ€§**ï¼›
* `by mutableStateOf()` è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ª **Compose å“åº”å¼çŠ¶æ€**ï¼›
* `private set` é™åˆ¶äº†å¤–éƒ¨ä»£ç ä¸èƒ½ç›´æ¥ä¿®æ”¹ï¼Œåªèƒ½è¯»å–ï¼›
* ä½†ç±»çš„å†…éƒ¨å¯ä»¥è‡ªç”±ä¿®æ”¹å®ƒï¼Œä¾‹å¦‚ï¼š

  ```kotlin
  fun updateTheme(newColor: Color) {
      bottomBar = newColor
  }
  ```

å½“ä½ ä¿®æ”¹è¿™äº›å±æ€§æ—¶ï¼ˆä¾‹å¦‚ `bottomBar = Color.Red`ï¼‰ï¼Œ
Compose ä¼šè‡ªåŠ¨è§¦å‘ UI é‡ç»„ï¼ˆrecompositionï¼‰ã€‚

---

### ğŸ§  ä¸‰ã€æ€»ç»“ä¸€ä¸‹åŒºåˆ«ï¼š

| å±‚çº§   | åç§°                                     | å¯å˜æ€§         | ç”Ÿå‘½å‘¨æœŸ      | ç”¨é€”    |
| ---- | -------------------------------------- | ----------- | --------- | ----- |
| æ„é€ å‚æ•° | `bottomBar: Color`                     | âŒ ä¸å¯å˜       | ä»…é™æ„é€ å‡½æ•°    | åˆå§‹åŒ–çŠ¶æ€ |
| ç±»å±æ€§  | `var bottomBar by mutableStateOf(...)` | âœ… å¯å˜ï¼ˆä½†å¤–éƒ¨åªè¯»ï¼‰ | æ•´ä¸ªå¯¹è±¡ç”Ÿå‘½å‘¨æœŸå†… | å“åº”å¼çŠ¶æ€ |

---

### ğŸ’¬ æ¢å¥è¯è¯´ï¼š

* æ„é€ å‚æ•°åªæ˜¯â€œåˆå§‹å€¼â€ï¼›
* ç±»å†…éƒ¨çš„ `mutableStateOf()` å±æ€§æ‰æ˜¯çœŸæ­£â€œå¯å˜â€çš„çŠ¶æ€æºï¼›
* ä½ å¯ä»¥é€šè¿‡æ–¹æ³•æ›´æ–°å®ƒï¼Œä½†å¤–éƒ¨æ— æ³•ç›´æ¥æ”¹åŠ¨ã€‚

---

æ˜¯å¦éœ€è¦æˆ‘å¸®ä½ ç”»ä¸€å¼ ç»“æ„å›¾ï¼Œæ˜¾ç¤ºâ€œæ„é€ å‚æ•° â†’ çŠ¶æ€å±æ€§ â†’ Compose ç›‘å¬â€çš„æ•°æ®æµï¼Ÿ


----------------------------------------------------------------------------------------------------------------------
internal open class SnapshotMutableStateImpl<T>(
    value: T,
    override val policy: SnapshotMutationPolicy<T>
) : StateObjectImpl(), SnapshotMutableState<T> {
    @Suppress("UNCHECKED_CAST")
    override var value: T
        get() = next.readable(this).value
        set(value) = next.withCurrent {
            if (!policy.equivalent(it.value, value)) {
                next.overwritable(this, it) { this.value = value }
            }
        }

ä½ æ˜¯æƒ³è¯´ï¼Œè¿™ä¸ªstateå¯¹è±¡åˆ¤æ–­è§†ä¸ºåŒä¸€ä¸ªä¸ä¼šå¯¼è‡´é‡ç»„å¯¹å—ï¼Ÿä½†æ˜¯é’ˆå¯¹kotlinè¯­æ³•è°ƒç”¨æ„é€ æ–¹æ³•å°±ä¼šå¯¼è‡´å¯¹è±¡é‡å»ºå§

æ ¹æ®val å¯¹è±¡çš„å‚æ•°ï¼Œåªè¦== è§†ä¸ºç»“æ„æ€§ç›¸ç­‰ï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿä¸ä¼šå¯¼è‡´é‡å»º

ä½†æ˜¯æˆ‘ä»¬è¿™ä¸ªä¸»é¢˜é‡Œé¢çš„æ•°æ®ç¡®æ˜¯æ›´æ–°äº†ï¼Œå°±ä¼šå¯¼è‡´é‡ç»„äº†



-------------------------

ğŸ‘ğŸ‘ éå¸¸å¥½ï¼Œä½ ç°åœ¨è®²çš„å…¶å®å·²ç»åˆ°äº† **Compose runtime çš„åº•å±‚è¡Œä¸ºå±‚çº§**äº†ã€‚
ä½ çš„åˆ†æå®Œå…¨æ­£ç¡®ï¼Œä¸‹é¢æˆ‘å¸®ä½ æŠŠè¿™ä¸‰ä»¶äº‹å½»åº•åˆ†æ¸…æ¥šâ€”â€”ä½ æåˆ°çš„

> â€œæ„é€ æ–¹æ³•é‡å»ºå¯¹è±¡â€ã€
> â€œstateåˆ¤æ–­æ˜¯å¦ç­‰ä»·è§¦å‘é‡ç»„â€ã€
> â€œä¸»é¢˜æ›´æ–°å¼•èµ·çš„ UI é‡ç»˜â€

å®ƒä»¬ç¡®å®æ˜¯**ä¸‰ä¸ªä¸åŒå±‚çº§**çš„è¡Œä¸ºï¼Œæˆ‘ä»¬ä¸€å±‚å±‚å¾€ä¸‹æ‹†ã€‚

---

## ğŸ§© ä¸€ã€Kotlin å±‚é¢ï¼šæ„é€ æ–¹æ³•è°ƒç”¨ â‰  çŠ¶æ€æ›´æ–°

ä½ è¯´å¾—å¯¹ï¼š

> â€œåªè¦è°ƒç”¨æ„é€ æ–¹æ³•ï¼Œå°±ä¸€å®šä¼šåˆ›å»ºæ–°å¯¹è±¡ã€‚â€

âœ… å¯¹ï¼Œè¿™åœ¨ Kotlin å±‚é¢æ˜¯æ²¡å¾—å•†é‡çš„ã€‚
`WeComposeColors(...)` è°ƒç”¨æ„é€ å‡½æ•°ä¸€å®šä¼šåˆ†é…æ–°å®ä¾‹ï¼ˆæ— è®ºä½ æ˜¯ä¸æ˜¯ @Stableï¼‰ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

```kotlin
val old = WeComposeColors(Color.Red)
val new = WeComposeColors(Color.Blue)
```

è¿™é‡Œå°±æ˜¯ä¸¤ä¸ªå¯¹è±¡ï¼Œå“ªæ€•å­—æ®µå€¼ä¸€æ¨¡ä¸€æ ·ã€‚
**Kotlin ä¸ä¼šè‡ªåŠ¨å¤ç”¨å¯¹è±¡ã€‚**

---

## ğŸ§  äºŒã€Compose å±‚é¢ï¼šrecomposition â‰  é‡æ–°åˆ›å»ºå¯¹è±¡

Compose åªåœ¨**state å˜åŒ–**æ—¶é‡ç»„ï¼Œ
ä½† Compose **ä¸ä¼šå¸®ä½ â€œè®°ä½â€ Kotlin å¯¹è±¡**ã€‚
ä½ å¿…é¡»æ‰‹åŠ¨ç”¨ `remember { ... }` å»ä¿ç•™å¯¹è±¡å¼•ç”¨ã€‚

å¦åˆ™æ¯æ¬¡é‡ç»„éƒ½ä¼šé‡æ–°æ‰§è¡Œ Composable çš„å‡½æ•°ä½“ â†’ é‡æ–°è°ƒç”¨æ„é€ æ–¹æ³• â†’ æ–°å¯¹è±¡ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

```kotlin
@Composable
fun Demo() {
    val colors = WeComposeColors(...)  // âŒ æ¯æ¬¡é‡ç»„éƒ½ new
}
```

å’Œ

```kotlin
@Composable
fun Demo() {
    val colors = remember { WeComposeColors(...) }  // âœ… åªåˆ›å»ºä¸€æ¬¡
}
```

çš„åŒºåˆ«æ˜¯ï¼š

* å‰è€…ï¼šæ¯æ¬¡é‡ç»„ï¼ˆæ¯”å¦‚åŠ¨ç”»å¸§ï¼‰éƒ½ä¼šé‡æ–°èµ°æ„é€ æ–¹æ³•ï¼›
* åè€…ï¼šè®°ä½äº†å¼•ç”¨ï¼Œåªä¼šä¿®æ”¹å†…éƒ¨ stateï¼Œä¸ä¼š newã€‚

---

## âš™ï¸ ä¸‰ã€SnapshotMutableStateImpl çš„è¡Œä¸ºé€»è¾‘

ä½ è´´çš„æºç æ˜¯ Compose å†…éƒ¨çš„å¯å˜çŠ¶æ€å®ç°ï¼š

```kotlin
if (!policy.equivalent(it.value, value)) {
    next.overwritable(this, it) { this.value = value }
}
```

è¿™å¥è¯çš„æ„æ€æ˜¯ï¼š

> â€œåªæœ‰å½“æ–°å€¼å’Œæ—§å€¼ä¸ç­‰ä»·ï¼ˆ`!policy.equivalent(...)`ï¼‰æ—¶ï¼Œæ‰ä¼šè§¦å‘å†™å…¥ã€æ ‡è®°å¿«ç…§è„ã€å¹¶æœ€ç»ˆå¼•å‘é‡ç»„ã€‚â€

ä¹Ÿå°±æ˜¯è¯´ï¼š

* `mutableStateOf(Color.Red)` â†’ å†æ¬¡èµ‹å€¼ `Color.Red`ï¼šä¸ä¼šé‡ç»„ï¼›
* æ”¹æˆ `Color.Blue`ï¼šè§¦å‘é‡ç»„ã€‚

âœ… æ‰€ä»¥ Compose çš„â€œé‡ç»„è§¦å‘ç‚¹â€ä¸æ˜¯â€œå¯¹è±¡é‡æ–°åˆ›å»ºâ€ï¼Œ
è€Œæ˜¯â€œ`mutableStateOf` åŒ…è£¹çš„å€¼åœ¨è¯­ä¹‰ä¸Šæ˜¯å¦å˜åŒ–ï¼ˆç”± policy å†³å®šï¼‰â€ã€‚

---

## ğŸ§± å››ã€ä½ è¯´çš„â€œä¸»é¢˜æ•°æ®æ›´æ–°ä¼šå¯¼è‡´é‡ç»„â€æ˜¯å¯¹çš„

å½“æˆ‘ä»¬è°ƒç”¨ï¼š

```kotlin
colors.update(bottomBar = newColor)
```

å†…éƒ¨çš„ï¼š

```kotlin
var bottomBar by mutableStateOf(bottomBar)
```

æ£€æµ‹åˆ°å€¼ä¸åŒ â†’ è§¦å‘ snapshot å†™å…¥ â†’ æ‰€æœ‰è¯»å–äº†è¯¥çŠ¶æ€çš„ Composable ä¼šé‡ç»„ã€‚

âœ… æ‰€ä»¥è¿™ç±»æ›´æ–°ä¼šå¼•èµ·å±€éƒ¨é‡ç»„ï¼ˆä½†ä¸ä¼š new å¯¹è±¡ï¼‰ã€‚

---

## ğŸ§­ äº”ã€ä¸‰ä¸ªå±‚çº§æ€»ç»“ä¸€ä¸‹åŒºåˆ«

| å±‚çº§                  | æœºåˆ¶                        | è§¦å‘æ¡ä»¶                           | æ˜¯å¦é‡å»ºå¯¹è±¡ | æ˜¯å¦è§¦å‘ Compose é‡ç»„ |
| ------------------- | ------------------------- | ------------------------------ | ------ | --------------- |
| Kotlin æ„é€ å‡½æ•°         | è°ƒç”¨ `WeComposeColors(...)` | æ¯æ¬¡æ‰§è¡Œæ„é€ å‡½æ•°                       | âœ… æ˜¯    | âœ… æ˜¯ï¼ˆæ–°çš„å¼•ç”¨ï¼‰       |
| `mutableStateOf` å†™å…¥ | å†…éƒ¨å€¼å˜åŒ–                     | `!policy.equivalent(old, new)` | âŒ å¦    | âœ… æ˜¯ï¼ˆå±€éƒ¨é‡ç»„ï¼‰       |
| é‡æ–° remember         | key å˜åŒ–æˆ– remember ä¸å­˜åœ¨      | æ¯æ¬¡ composition åˆå§‹åŒ–             | âœ… æ˜¯    | âœ… æ˜¯ï¼ˆå¯¹è±¡é‡å»ºï¼‰       |

---

## ğŸ’¬ å…­ã€ä½ é‚£å¥â€œæˆ‘ä»¬ä¸»é¢˜é‡Œæ•°æ®ç¡®å®æ›´æ–°äº†å°±ä¼šå¯¼è‡´é‡ç»„â€éå¸¸ç²¾ç¡®

æ²¡é”™ã€‚
`WeComposeColors` æ˜¯ **åŒä¸€ä¸ªå¯¹è±¡**ï¼Œ
ä½†å®ƒå†…éƒ¨çš„ `mutableStateOf` è§¦å‘äº† Snapshot å˜æ›´ï¼Œ
Compose runtime è¿½è¸ªåˆ°ä¾èµ–å®ƒçš„ Composable â†’ è‡ªåŠ¨å±€éƒ¨é‡ç»„ã€‚
è¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„è¡Œä¸ºã€‚

---

## âœ… ç»“è®ºï¼ˆç®€æ˜ç‰ˆï¼‰

> * æ„é€ å‡½æ•°è°ƒç”¨ â†’ ä¸€å®šé‡å»ºå¯¹è±¡ã€‚
> * `mutableStateOf` æ”¹å€¼ â†’ ä¸é‡å»ºå¯¹è±¡ï¼Œåªè§¦å‘é‡ç»„ã€‚
> * Compose çš„â€œæ˜¯å¦é‡ç»„â€åˆ¤æ–­ç”± `SnapshotMutationPolicy` æ§åˆ¶ï¼Œä¸å…³æ„é€ å‡½æ•°çš„äº‹ã€‚
> * åŠ¨ç”»åªæ˜¯ä¸æ–­åœ°è§¦å‘ state æ›´æ–°ï¼Œè€Œä¸æ˜¯ä¸æ–­ new å¯¹è±¡ï¼ˆå‰ææ˜¯ä½ ç”¨ `remember` ç¼“å­˜ä½äº†ï¼‰ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç›´æ¥è´´å‡ºä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆæ‰“å° hashCode + recomposition countï¼‰ï¼Œ
å®æµ‹å±•ç¤ºâ€œé¢œè‰²åœ¨åŠ¨ç”»å˜åŒ–æ—¶å¯¹è±¡ä¸é‡å»ºï¼Œä½†è§¦å‘é‡ç»„â€çš„å…¨è¿‡ç¨‹ã€‚
è¦ä¸è¦æˆ‘å†™ç»™ä½ ï¼Ÿ



----------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------