
@Composable
fun ChatListPage(
    chats: List<Chat>,
    viewModel: WeViewModel = viewModel()
) {
    Column(
        modifier = Modifier
            .background(WeComposeTheme.colors.background)
            .fillMaxSize()
    ) {
        WeTopBar(title = "扔信")

        LazyColumn(
            modifier = Modifier.background(WeComposeTheme.colors.listItem)
        ) {
            itemsIndexed(chats) { index, chat ->
                //1. 避免在 Item 里直接拿 viewModel()：保持 可组合函数的纯粹性
                ChatListItem(
                    chat = chat,
                    onClick = { viewModel.startChat(chat) }
                )

                if (index < chats.lastIndex) {
                    Divider(
                        modifier = Modifier.padding(start = 68.dp),
                        color = WeComposeTheme.colors.chatListDivider,
                        thickness = 0.8.dp
                    )
                }
            }
        }
    }
}

@Composable
fun ChatListItem(
    chat: Chat,
    onClick: () -> Unit
) {
    Row(
        modifier = Modifier
            .clickable { onClick() }
            .fillMaxWidth()
            .padding(horizontal = 8.dp, vertical = 6.dp)
    ) {
        ChatAvatar(
            avatarRes = chat.friend.avatar,
            showBadge = !chat.msgs.last().read,
            contentDescription = chat.friend.name
        )

        Spacer(modifier = Modifier.width(8.dp))

        Column(
            modifier = Modifier
                .weight(1f)
                .align(Alignment.CenterVertically)
        ) {
            Text(
                text = chat.friend.name,
                fontSize = 17.sp,
                color = WeComposeTheme.colors.textPrimary
            )
            Text(
                text = chat.msgs.last().text,
                fontSize = 14.sp,
                color = WeComposeTheme.colors.textSecondary,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
        }

        Text(
            text = chat.msgs.last().time,
            modifier = Modifier
                .align(Alignment.Top)
                .padding(end = 12.dp, top = 8.dp),
            fontSize = 11.sp,
            color = WeComposeTheme.colors.textSecondary
        )
    }
}

@Composable
private fun ChatAvatar(
    @DrawableRes avatarRes: Int,
    showBadge: Boolean,
    contentDescription: String
) {
    Box(
        modifier = Modifier
            .size(48.dp)
            .clip(RoundedCornerShape(4.dp))
    ) {
        Image(
            painter = painterResource(id = avatarRes),
            contentDescription = contentDescription,
            modifier = Modifier.matchParentSize()
        )

        if (showBadge) {
            Box(
                modifier = Modifier
                    .align(Alignment.TopEnd)
                    .size(10.dp)
                    .background(
                        color = WeComposeTheme.colors.badge,
                        shape = CircleShape
                    )
            )
        }
    }
}

